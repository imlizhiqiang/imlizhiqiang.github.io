# 程序员的黑魔法：编写不可维护代码的艺术

黑魔法是反击 996 的武器。

---

黑魔法宣言

> 人是系统的一部分。代码+人=系统。
> 黑魔法攻击的不是系统，而是系统的可维护性，它不摧毁系统，而是摧毁系统的未来。就好像不亲手杀掉一个人，而让他不得不自杀(PUA?)。
> 很多时候，如果你觉得系统不合理，那么很可能是业务设计不合理，导致如果要实现如此不合理的业务，只能让系统做出妥协，而最初的妥协，就是系统崩溃的第一步。
> 代码是团队的镜子，一份好的代码可能并不能证明这个程序员本人的能力很好，但是一定能说明这个团队的能力很好，因为光凭一个人是无法改善团队的代码质量的，是需要沟通配合的。
> 黑魔法的产品，是一个功能性百分之百，可维护性百分之零的系统。
> 单纯的代码重构，对系统的提升作用是有限的，最终会反映到团队，以及业务上，这时真正的阻力才会来临。
> 最终将会是一个美其名曰升级的重做，比如从 1.0 到 2.0 完全改变了架构。但是这无事于补，2.0 也必然是一堆垃圾。垃圾的团队，垃圾的领导，只能产出垃圾。一个不懂技术的领导，将完全摧毁系统，一个懂点技术却不参加一线开发的领导更加危险，将完全摧毁系统，以及整个团队。

代码的可读性等同于系统的可维护性。你若想维护某物，必先理解它，如何理解系统？唯有通过代码。

修习黑魔法者，承认这样一个前提，即至高真理：可维护性至高，全面凌驾于稳定性之上，一个可维护的但是不稳定的系统，远远好于一个不可维护的稳定的系统。

什么样的代码是好代码?朴实无华甚至有些呆板木讷的代码,没有花里胡哨的技巧,设计思想化于无形.

至高真理的本质，来自于这样的思想：如果想让系统长期有效，只能通过人的控制和维护，人应该对系统有绝对的掌控，无远弗届，事无巨细，如臂使指。

试图保持系统稳定是愚蠢的，外部环境是不断变化的，需求是不断产生的，系统是动态的，时刻变化的，不断演进的，变化本身就说明了它有不稳定的趋向。

系统不可能静态稳定，只会动态稳定。

已经稳定线上运行的系统，希望在正常提供服务的前提下做全系统重构，这相当于为正在飞行的飞机更换发动机，是非常高难度的动作，但并非不可以完成，只是需要对团队的能力提出非常高的要求，注意是整个团队，并非只有团队中的技术人员。

这样的系统忘记了一个基本前提，系统是运行在环境中的，而环境是不断变化的，在不断变化的环境中，系统却试图保持以不变应万变的稳定性，这显然是白日做梦。

强调系统稳定性的人，他们内心其实并不是想强调系统的稳定性，而是强调【收益的稳定性】，因为系统崩溃或者生产环境的 bug 显然意味着【当前】利益的损失，也就是说，他们不关心系统，他们只关心利益，只关心钱，顺着这个思路推想到极限，就能明白，对这些人来说，即使代码如天书般不可读，即使在光鲜的外表下是扭曲腐烂的内核，只要系统能够运行，眼下不出问题，让他们得到他们的利益，他们就会满意。你也能注意到这种思维背后的短视性：他们毫无远见，只能看到眼下的钱，甚至不关心明天还能不能挣到钱。

黑魔法将让这些人明白，唯利是图者只能收获短期利益，且他们将不可避免地走向崩溃。甚至将会不得不把已经到嘴里的钱再吐出来。

使用黑魔法的程序员，他们并非召唤魔鬼的人，他们本身就是魔鬼，他们将与短视之辈订立契约，给予他们稳定性，给予他们利益，给予他们歌舞升平的现在，作为交换，拿走他们的可维护性，为他们安排下满目疮痍的未来。这个未来本来只是一种可能性，是可以避免的，但黑魔法将让这种可能性变为命中注定,一定会在某一天变为铁一般的现实。比起这些人来，黑魔法使用者仿佛是先知，能预言必然的未来。所以黑魔法的核心其实是远见。黑魔法的效果将在未来显现，今天的一切都将固定那个未来，就好比你种下的种子，你知道它一定会发芽。

愿意做魔鬼的人，继续读下去吧。

---

若要写出优雅流畅，可读性极高的代码，需要常年的严格训练和自省，及对系统本质、语言抽象概念的深刻认知，对自己编程手艺的精益求精。

若要修习黑魔法，需在此基础上更进一步，也就是说，能熟练使用黑魔法的人，其必先是一个能写出高可读性代码的人。如此他才能知道，代码中的哪个部分，对可读性影响最大，也就是黑魔法攻击的目标所在。

若要攻击，必先了解。

写出完美的不可维护的代码，要比写出完美的可维护的代码要求的水平更高。

---

天然适合被黑魔法攻击的团队

- 业务领导技术，唯利是图的领导层，惯用语是“我只看结果”，每天沉迷于各种图表不可自拔，以为那些数字的背后是一个美好的未来。这句话的潜台词其实是我只看眼下的钱。这种商人思维适合营销团队，不适合技术团队，看看暴雪公司的下场就知道了。无数的公司验证了这一点，如果有一天你自己开了一家公司，务必记住，只有工程师才能领导工程师。
- 外行领导内行，外行的项目管理人员或者中层管理人员，把时间浪费在开会上。毫无主见，不会对领导层据理力争，只是领导层的走狗。为了维护自己的利益，在公司内部频繁发起政治争斗。虽然三句话不离业务，但其实根本不关心公司和产品。
- 一盘散沙、手忙脚乱的开发人员，不惜一切代价完成眼下的需求，临时方案层出不穷。补丁一层摞一层。积重难返，为了保证功能，后面没人再敢动代码。
- 愚蠢的产品经理，扮演的角色不过是同样愚蠢的用户的传声筒和扩音器，传回来双倍的愚蠢需求。标准的特征是没有设计思路，只会传话，“这是用户提出来的”“这是老板要的”。更有甚者自作聪明地胡乱添加功能以显示工作成果，不会做减法。且产品经理总以为自己是程序员的领导。
- 平庸的架构师或者系统核心设计者，作为技术团队的带头人，完全才不配位。面对着多变的需求，最常见的处理手法是在数据库中“加一个字段”，敷衍了事，麻木不仁，对危机没有敏锐的嗅觉。后面再也不会回过头来处理这个临时方案。
- 面试的时候你就能看出来技术领导是不是一个蠢货，那种恨不能把 jvm 源码倒背如流的家伙，孔乙己一般迷恋着一些冷门细节的家伙，这样的蠢货在黑魔法的面前死都不知道怎么死的。
- “先做出来保证上线，后面遇到问题再改”，听到这句话的时候你就应该做好思想准备，最初的警钟已经敲响了，系统的未来很悲观，只需要很少的时间，你就可以看到一个确定的未来，系统已经完了，准备给它收尸，下葬，然后赶紧各奔前程吧。

各种“内部系统”，都是 to B 的，比如乱七八糟的 OA、ERP、政务系统等等，几乎是黑魔法天然的攻击对象，它们是如此地合适，就好像你手里拿着一把上了膛的好枪面对着一个崭新鲜艳的靶子一样，你如果不瞄准发射的话，都觉得对不起这个靶子。但本着盗亦有道的原则，不建议攻击政务系统，因为毕竟关系到民生事务。

我相信，从统计学角度观察，绝大多数的开发团队都符合以上描述，就好像大多数人都很愚蠢是一个道理，毕竟现在是互联网时代，在可预想到的未来，计算机技术仍将越来越快、越来越深刻地影响人类社会，计算机网络作为人类社会信息流动的高速公路，几乎相当于人体中的神经系统，哪怕在今天，说整个人类现代社会的运转都建立在计算机上，也不算过分。在这样的大背景和利益驱动下，大量的外行人一头扎进开发圈，那么满地的软件作坊、短视的领导层、业余开发团队也就不足为奇了。

如果你身为一个黑魔法修习者，且身在这样的团队，我想没人能抑制你使用黑魔法为这个团队，尤其是他们的领导者，揭示第一真理的欲望吧？

---

认为“铁打的硬盘流水的兵”，认为“程序员就是流水线工人，是随时可以替换的零件”，这样的人是愚蠢的，这种想法是错误的，流水线工人是劳动密集，而程序员是知识密集，流水线工人可以培训，可以熟能生巧，但程序员不能。

流水线工人把同样的工作执行几万次，甚至形成肌肉记忆，边做梦边干活都不会出错，他也没法提升。而程序员在多年的编程中，将总结出自己的经验心得。程序员是累积经验的技术工种。

编程，即使是最简单的、几乎毫无技术含量和技巧性的增删改查动作，这个人也并不是简单就可以培训替换掉的。对比生产线工人，上岗之前可以完全不了解这个生产过程，完全从一张白纸开始，比如说搬砖，只要你身体健康有力气就可以，但是编程不行。编程相当于即使你来搬砖，也要求你是体校毕业，且必须亲手烧制过砖。替换一个程序员的成本其实是很高的。但是诡异的是，很多领导宁可花更多的钱换人，并伤害系统，也不会给老人涨薪。

抱有这种想法的领导层是短视的，也天然适合被攻击。

---

黑魔法的本质就是反重构，且如果施加过黑魔法，试图通过重构来解除，是不可能的。黑魔法本身就被设计为一次性的、不可逆的改变，这种毒药绝没有解药。覆水难收。

黑魔法施放过后，代码越混乱，说明黑魔法修习等级越低，高等级者，能让代码看上去仍然保持优雅甚至更加简洁（看上去几乎像是一次重构），似乎仍然具备着高可读性，但是真正读起来却佶屈聲牙，似是而非，模棱两可，似乎在系统本质与代码文本之间，蒙上了一层迷雾，朦朦胧胧之中，系统本质似乎就在前方，但实际上，那不过是【海市蜃楼】而已，读代码的人将不自知地迷失所有方向，在迷雾中徒劳地寻找，永远不可能真正理解系统。这个迷宫没有出口，只能越走越深，越走越远。

如果黑魔法完全地、明显地摧毁可读性，最多只会让系统被重写，虽然这会造成损失，但同时也让黑魔法变成一次性的短暂动作，毕竟重写很多时候其实是可以承受的。高级黑魔法追求造成持续伤害，仿佛绵绵不断的钝痛，远远算不上痛苦，但是纠缠不休。这会让人舍不得丢弃现有代码完全重写，觉得似乎还有可维护的余地，试图压低成本提高质量，殊不知已经陷入泥潭，越挣扎只会下沉越快而已。随着时间的流逝，伤害最终将累加至承受不了的程度，等到他们惊醒时为时已晚，最好的时间段已经过去，即使重写也来不及了，因为连重写的时间也没有了。自施加高级黑魔法之后，所有参与这个项目，经手这个系统的人，都将毫无意义地耗费自己的时间。

这是因为黑魔法的攻击目标就是系统的可维护性，如果黑魔法成功，那么可维护性将是零，在此基础上所做的一切重构努力都将事实上加速系统熵的增加，最终的结果是不可挽回的崩溃。

比如让领导层看到，一次性有一百万的损失，领导层肯定无法接受，系统一定会推翻重写，但是如果是五万呢？可能就会被接受，但是他们不会想到，接下来是无法阻止的 20 次五万，甚至更多的无穷无尽的五万，这就是所谓的绵绵不断的钝痛。本质上是一种温水煮青蛙的战略。最终在预期战果之外，还额外收获时间。

黑魔法的高级用法，是不但让他们失去系统，还要让他们失去时间。使用隐形沉没成本拖垮他们。黑魔法的最终成果，就是系统腐烂，并在时间和金钱上消耗大量的沉没成本。是一种慢性的必死的毒药，无论花多少钱吃多少药，也挽回不了死亡的命运。且治疗过程中的一切痛苦都将变为沉没成本。

---

如果有可能，就使用多线程，没错，相信我，即使每家公司都会在他们的招聘要求上写上“精通多线程编程”，实际工作中，能真正深刻理解并熟练应用多线程的人是凤毛麟角，甚至连能理解的人都是少数，但是没关系，因为实际上多线程技术本身并不是那么常用。

多线程就像是炸药，你越了解它，越会尽量避免使用它，除非真的有必要。

使用多线程表面看来，将提升你程序的效率，并且显得无比高大上，但事实上，多线程由于本质中的随机性（CPU 时间片切换），可以埋下非常深非常隐蔽的雷，甚至你自己都可能不知道这个雷，而且试图修改多线程代码更加困难，尤其是水平不如你的人，借他们俩胆子也不敢动。而你的多线程代码因为：

- 看起来很高效
- 能够实现需求
- 改动困难

势必被尽可能地保留，于是黑魔法将奏效。

这个思路也可以扩展为在 js 中多使用异步。

毫无疑问，能使用黑魔法的人，不能是平庸之辈，要想使用黑魔法，自己的能力必须足够驾驭。

---

## 如何避免被黑魔法攻击

外行领导内行、急功近利、以金钱为导向，试图用包工头的方式领导软件开发团队，关键词是开会、流程、KPI、加班、画大饼、权力大于流程，等等。这是让团队迅速崩溃，产品迅速死亡的不二法门。

- 改吧改吧就上。
- 这么简单的功能很快就能出来，今天加班，明天就上。

如果你是开发转管理，那么请你明白，离一线开发越远，你越没有发言权，也许你以为你有那么几年开发经验能让你在团队中颇具威信，但实际上并非如此，你必须证明你的水平高于他们，能教他们东西才行。而且请你回想一下，你为什么要从开发转到管理，是不是因为开发实在干部下去呢？

半瓶子醋的外行，比完全不懂的外行更有杀伤力。

你离一线开发越远，越没有发言权，你闲来无事想了解一下新技术，然后在家里写的那些 demo 级别的代码，跟生产代码之间的差距好比小孩子的玩具车和一辆真车的差别，至于差在哪里，你上了高速公路自然会明白。

要避免黑魔法，首先要假设一个前提，团队的代码天然是低质量的，必须经过严格检验才能进入代码库，所以单元测试和 code review 一定要严格推行，并有专人负责，这里要小心避免这个规定变为一纸空文，执行中被忽视，那就需要团队有一个严格的死规定，未经检验的代码，哪怕公司马上就要破产，也绝不上线。从一开始就不让步，否则最终一定会演变成说一套做一套。

技术管理者不要一味地强行推行单元测试，单元测试代码写起来比较复杂繁琐，实践中容易使团队产生厌烦抵触情绪，要同步地推广一些比较好的单元测试技术或者框架，使部分测试自动化。但是单元测试是必须做的，是不容置疑的。

另外，团队要注意营造一种工程师的代码风格，简单平实，不耍小聪明，不画蛇添足，多做减法少做加法。阿里 2018 年的圣诞节彩蛋事件就是典型的案例，工程师自作聪明，抖机灵，团队风气轻浮，阿谀奉承成风，大搞官僚主义，审查虚有其表，最终损害的还是团队利益，甚至公司利益。

最重要的一点，就在于设计。最高级的黑魔法实际上是施加在设计上。实际工程中，系统都是具备一定规模的，所以设计是一切的基础。使用难于理解的抽象，错综复杂的继承关系，大量不合理的接口，再加上各种设计模式的应用，将对系统设计造成根本上的伤害。很多人不明白，简单的东西才是最坚固的。所以有一句名言说，代码足够简单，以至于明显没有 bug，代码足够复杂，以至于没有明显 bug，显然，一个工程级别的系统不可能那么简单，所以后面这半句就是黑魔法的用武之地。

没有捷径可走，要想保证罪犯不越狱，你只能天天盯着他。要想保证不受黑魔法攻击，你只能时刻警惕。

---

## 如何避免黑魔法攻击被发现

- 不要显露自己的能力，不要耍小聪明，让代码有呆板的感觉，显得无害，不要显得故意要捣乱的样子，比如起一些明显胡乱决定的变量名。
- 黑魔法应该毫无痕迹。
- 如果你的代码出现 bug，不要让人想到你是故意这么做，让他们觉得你是能力如此。且这个 bug 应该显得足够意外。
- 实现功能，这样第一没有人能责怪你，第二，他们会因为功能正常而拒绝改进，从而使黑魔法生效
- 黑魔法代码本身甚至可能是良好的代码，即伪装成白魔法。比如设计模式。

---

## 初阶黑魔法

只是比较晃眼，如果真的想改，还是可以改的。

- 晦涩的变量名和函数名
- 不准确的注释和遗留代码
- 一些可读性低的编码风格，比如开火车代码
- 使用函数式和递归来代替循环（比如 java 的 stream 用来代替 for 循环，因为 lambda 表达式的存在，会非常简短，但是修改就可能不是很方便，另外天然地鼓励写嵌套式代码，会导致可读性急速降低）
- 大量使用函数式重构代码,这可以让你的代码显得相当高档,如果是一个只会 java 的程序员,可能看都看不懂,退一步说他会了 java8 语法,也因为对函数式本身理解不深刻,无法上手修改,更有甚者,你的代码在他眼里是高手的作品
- 过度的通用（单点依赖，通过多参数方法聚合功能，在多模块工程中往common放进大量东西）或者过度的重复（复制粘贴代码）
- 多处近似依赖
- 不写注释和文档，或者注释和文档过期

试图设计过度通用的功能来尽可能地适应不同的业务，或者对每个业务都新建一套接口，这都不是正确的做法。这也说明了，单方面重构系统是徒劳的，业务本身也需要重构。系统应该对业务有反作用，而不是完全地实现业务。

多处近似依赖就是，比如说一个公共方法，很多地方依赖了它，如果修改，影响很大，且需要重新测试等等。重构一书中，给出的解决方案是另开一个方法，并逐步替换，这个方案只需简单改改就是黑魔法，另开一个方法，然后只替换一小部分，比如你本人负责的这部分功能，后面在新开更多的方法，还是只替换一小部分，这将导致非常类似的功能，实际上有很多的实现，并散落在代码不同的位置，这种烟雾弹式、迷魂阵式的代码，光整理依赖、寻找依赖代码位置，就已经很难了。典型的例子就比如各种日期操作，各种字符串操作的代码。

- 注释是个好东西，再也没有比这效果更好的烟雾弹了，而且更妙的是，注释绝不影响代码的运行，但确实能影响代码的质量。所以一个很好的黑魔法就是，写不准确的，模棱两可的，晦涩难懂的注释。
- 尽量封装对象，最好有个几十上百个属性，然后用来各种传参。即DTO。java语言没有命名参数和默认参数等特性，所以这种很多参数的场景只能封装来传，这时要想搞明白每个参数的意义就显得有些困难。


---

## 进阶黑魔法

进阶一点的黑魔法不在局部做文章，而是扭曲设计。

- 将逻辑安排在类调用链上不合适的位置，比如逻辑集中在 controller 或者 dao，而 service 层非常单薄。

要注意到数据库是系统的一部分，不要以为黑魔法只攻击代码本身，不合理的数据库设计从一开始就是系统的一个巨大隐患，而在数据库层面上对底层数据结构和模型设计做出更改是非常费力而困难的，随着时过境迁，技术人员不断地使用临时补丁，数据库中各种不合理的表与随意添加的字段会暴增，而这时库中的数据又是真实的，越发难以修改。

---

## 设计模式（高阶黑魔法内容，直接进攻设计）

> 这套绝世刀法的招式是如此炫目，以至于死于刀下之人在临死之际还赞叹不已。

让设计模式闪瞎那帮二傻子的狗眼吧。

有 new 不老老实实地用，非得用 builder 模式。（thoughtsworks）

thoughtsworks 为代表的一系列号称著名的咨询公司，其写出的代码充斥着过度设计，画蛇添足，花拳绣腿，自以为是。恨不能写个 helloworld 也用上它十个八个的设计模式。但是又高高在上，自以为高明。而且不写注释。不写注释的代码就是垃圾代码,没有单元测试的代码就是垃圾代码,既不写注释又不写测试,就是垃圾代码的平方.

设计模式这种东西，除非有必要，否则不要用，设计模式的缺点在于增加了抽象层级，如果不能理解其中的设计思路，根本无从下手修改。设计模式在高手的手中是改善代码可维护性的工具，但是在庸手手中，会起到适得其反的效果。

使用设计模式来作为黑魔法，其高妙之处在于，目标明明被攻击，却只能打碎牙往肚子里咽，明明代码维护起来焦头烂额，却心甘情愿承认自己水平不行，高呼大神不止，被人卖了还替人数钱。

## 函数式

函数式绝对是黑魔法的神兵利器.使用函数式代替循环只是初阶中的初阶,函数式可以直接进攻设计.

---

## 贪婪和愚蠢

---

## 黑魔法与白魔法

实际上你会发现，黑魔法和白魔法其实是正反两面，它们及其相似。也就是说，可维护性高的代码，和可维护性为零的代码，可能看起来是同样的代码。

举个例子，就是注释，好的代码，其注释简单明了，干脆利落，且使用简单的单词和语法，不喧宾夺主，在代码旁边默默地承担辅助功能。而黑魔法代码，其注释看上去也很规范，但在关键说明处却模棱两可，顾左右而言他，大片的注释其实是鸡汤般的空洞废话，看似很有用，实则毫无意义。而完全没有注释的代码则只能被称为平庸的代码，连参与评价的资格都没有。

高级的黑魔法与高级的白魔法，同样在设计上下功夫。
